b4w.register("victory_day_2015_main",function(db,d){function eb(a,c){if(c){k=a;Ca.pause();fb();var b=gb.get_std_assets_path();hb.load(b+"victory_day_2015/main_scene.json",ib,jb);Da();window.addEventListener("resize",Da)}else console.log("b4w init failure")}function Y(a){if(q){var c=Z.get_coords_x(a);a=Z.get_coords_y(a);Ea(c,a);Fa(c,a)}}function Q(){ja&&(ja=!1,ka?(q=null,kb()):(C.pop(),C.pop(),l.remove_object(q),q=null,--t))}function kb(){var a=C[C.length-2],c=C[C.length-1],b=m.get_tsr(a,h.create()),
e=m.get_tsr(c,h.create()),D=h.transform_vec3(Ga,e,e);E.animate(0,1,500,function(e){var g=h.interpolate(b,D,I.smooth_step(e),h.create());m.set_tsr(a,g);1==e&&lb(a,c)})}function lb(a,c){var b=m.get_tsr(a,h.create()),e=m.get_tsr(c,h.create());Math.round(Math.random())?p.play_def(Ha):p.play_def(Ia);E.animate(0,1,500,function(g){var z=h.interpolate(b,e,I.smooth_step(g),h.create());m.set_tsr(a,z);1==g&&(k.addEventListener("mousedown",B),k.addEventListener("touchstart",B),S.append_stiff(a,c,u.set(0,0,0,
aa)),J.set_nodemat_value(K,["control_box","Value"],1))})}function B(a){a.preventDefault&&a.preventDefault();var c=Z.get_coords_x(a);a=Z.get_coords_y(a);var b=l.pick_object(c,a);if(b)switch(l.get_object_name(b)){case "rockets_box":if(16!=t){t+=1;q=b=J.copy(Ja,"rocket_"+t);C.push(b);var e="";10>t&&(e="0");la=e=l.get_object_by_dupli_name("bm_13","rail_"+e+t);C.push(e);l.append_object(b);Ea(c,a);Fa(c,a);ja=!0}break;case "control_box_button":ba=2,mb()}}function mb(){t&&(k.removeEventListener("mousedown",
B),k.removeEventListener("touchstart",B),p.stop(ma),p.play_def(ma),b.apply(A,"press_button_Action"),b.set_behavior(A,b.AB_FINISH_STOP),b.play(A),b.set_speed(L,-1),b.play(L,function(){b.apply(n,"bm_13_Armature_rotate_-37_Action");b.set_first_frame(n);b.set_behavior(n,b.AB_FINISH_STOP);b.play(n,nb)}))}function nb(){var a=b.apply,c=b.play,f=b.set_behavior;a(g,T);b.set_frame(g,b.get_anim_start_frame(n));f(g,b.AB_FINISH_STOP);c(g,ob);a(K,"hide_control_box_Action");a(A,"hide_control_box_Action");f(K,b.AB_FINISH_STOP);
f(A,b.AB_FINISH_STOP);c(K);c(A);p.stop(U)}function ob(){for(var a=1;a<=t;a++)pb(a)}function pb(a){var c=l.append_object,f=S.append_stiff,e=b.apply,D=J.copy,z=b.play,d=S.remove,V=l.remove_object,y=b.set_behavior,n=l.show_object,r="";10>a&&(r="0");var M=l.get_object_by_name("rocket_"+a),x=l.get_object_by_dupli_name("bm_13","rail_"+r+a);d(M);var q=D(Ka,"rocket_flash_"+a),v=D(La,"rocket_plume_"+a),w=D(na,"rocket_start_smoke_"+a),F=D(oa,"settling_smoke_"+a);E.set_timeout(function(){c(q);c(v);c(w);c(F);
n(w);n(F);e(q,"rocket_flash_Shader_NodetreeAction");e(v,"rocket_plume_start_Shader_NodetreeAction");e(w,"rocket_start_smoke_Shader_NodetreeAction");e(w,"rocket_start_smoke_finalscale",b.SLOT_1);e(F,"settling smoke_Shader_NodetreeAction");y(v,b.AB_FINISH_STOP);y(q,b.AB_FINISH_STOP);y(w,b.AB_FINISH_STOP);y(w,b.AB_FINISH_STOP,b.SLOT_1);y(F,b.AB_FINISH_STOP);y(N,b.AB_FINISH_STOP);y(O,b.AB_FINISH_STOP);f(q,M,pa);f(v,M,pa);f(w,x,rb);d(w);f(F,M,pa);z(q);z(w,function(){V(w)});var D=h.identity(h.create()),
r=h.identity(h.create());m.get_tsr(w,D);m.get_tsr(w,r);E.animate(0,.5,1E3,function(a){r[1]=D[1]-a;m.set_tsr(w,r)});E.set_timeout(function(){z(w,null,b.SLOT_1)},b.frame_to_sec(9));z(F,function(){d(F);V(F)});z(v,function(){e(v,"rocket_plume_loop__Shader_NodetreeAction");y(v,b.AB_CYCLIC);z(v)});E.set_timeout(function(){d(F)},100);p.play_def(qa);var u=m.get_tsr(M,h.identity(h.create())),A=h.create();h.copy(u,A);var qb=h.transform_vec3(Ma,u,A);if(ra?0:a==(0>=t?1==t?1:t-1:t-0))ra=!0,e(N,"residual_smoke_Armature_Action"),
e(O,"residual_smoke_Shader_NodetreeAction"),e(G,"rocket_smoke_Shader_NodetreeAction"),e(G,"rocket_smoke_finalscale",b.SLOT_1),b.set_first_frame(N),b.set_first_frame(O),b.set_first_frame(G),b.set_first_frame(G,b.SLOT_1),y(N,b.AB_FINISH_STOP),y(O,b.AB_FINISH_STOP),y(G,b.AB_FINISH_STOP),y(G,b.AB_FINISH_STOP,b.SLOT_1),z(G),z(G,null,b.SLOT_1),E.set_timeout(function(){n(O);z(N);b.play(O,function(){ra=!1;m.set_tsr(g,Na);var a=m.get_rotation(g,sa),a=R.rotateX(a,Math.PI,Oa);m.set_rotation_v(g,a);a=l.hide_object;
a(ca);a(da);a(ta);b.apply(W,"9may_atlas_Shader_NodetreeAction");b.set_first_frame(W);b.set_behavior(W,b.AB_FINISH_STOP);p.stop(ea);p.play_def(ea);fa=0;for(a=2;a<=t+1;a++)sb(a)})},500);1==a&&ua.set_light_params(H,{light_energy:20});E.animate(0,1,2E3,function(c){var b=h.interpolate(u,qb,I.smooth_step(c),h.identity(h.create()));m.set_tsr(M,b);m.set_translation(H,b[0],b[1]+8,b[2]);1==c&&(d(q),d(v),V(M),V(q),V(v),a==t&&(C=[],p.stop(qa),k.addEventListener("mousedown",B),k.addEventListener("touchstart",
B)))})},250*a)}function Ea(a,c){var b=Pa.calc_ray(g,a,c,tb),e=Qa.get_pline_directional_vec(b,aa),b=m.get_translation(g,Ra),e=u.scale(e,3,va),b=u.add(b,e,Sa);b[1]=I.clamp(b[1],.5,3);m.set_translation_v(q,b)}function Fa(a,b){var f=m.get_translation(q,aa),e=m.get_rotation(q,sa),h=m.get_translation(la,Ra),d=m.get_rotation(la,Oa),l=Pa.project_point(g,h,va),k=a-l[0],l=b-l[1],k=Math.sqrt(k*k+l*l);400>k?ka=!0:(ka=!1,k=400);l=I.quat_to_dir(e,I.AXIS_MY,va);f=u.subtract(f,h,Sa);u.normalize(f,f);f=R.rotationTo(l,
f,ub);R.multiply(f,e,e);R.normalize(e,e);e=R.slerp(d,e,k/400,vb);m.set_rotation_v(q,e)}function wa(){var a=document.querySelector("#content"),b=document.querySelector("#info_container"),f=document.querySelector("#footer");ga>window.innerHeight+10?(ga-50>=window.innerHeight&&(f.style.backgroundImage="url(icons/scroll_img.png)",a.style.backgroundImage="url(icons/scroll_fade_img.png)"),440>window.innerHeight?(a.style.display="none",f.style.backgroundImage="",a.style.backgroundImage=""):(ga-50>=window.innerHeight&&
(f.style.backgroundImage="url(icons/scroll_img.png)",a.style.backgroundImage="url(icons/scroll_fade_img.png)"),a.style.display="",a.style.height=b.offsetHeight-200-175+"px"),380>window.innerWidth&&(a.style.height=parseInt(a.style.height)+70+"px")):(a.style.height="",f.style.backgroundImage="",a.style.backgroundImage="")}function ib(){var a=P.get_url_params();if(a&&"lang"in a){var c="ru";"ru"==a.lang&&(c="en");var a=document.querySelector("#social_buttons."+c),f=document.querySelector("#info."+c),
c=document.querySelector("#run_button."+c);a.parentNode.removeChild(a);f.parentNode.removeChild(f);c.parentNode.removeChild(c)}X=document.querySelector("#replay");xa=X.querySelector("#replay_circle");x=document.querySelector("#info_container");ha=document.querySelector("#blend4web_logo");ia=document.querySelector("#social_buttons");c=l.get_object_by_dupli_name;a=l.get_object_by_name;g=l.get_active_camera();W=c("9_may_logo","planes");ca=c("firework","firework_1");da=c("firework","firework_2_1");ta=
c("firework","firework_2_2");Ja=c("rocket","rocket");Ta=a("Empty_camera_position_2");U=c("red_square","noise_spk");ma=c("control_box","button_spk");Ha=c("bm_13","load_spk");Ia=c("bm_13","load_spk_2");n=c("bm_13","bm_13_Armature");ea=c("bg","fireworks_spk");K=c("control_box","control_box");A=c("control_box","control_box_button");qa=c("bm_13","shot_spk");Ka=c("rocket_plume_flash","rocket_flash");La=c("rocket_plume_flash","rocket_plume");na=c("rocket_start_smoke","rocket_start_smoke");N=c("residual_smoke",
"residual_smoke_Armature");O=l.get_object_children(N)[0];oa=c("settling smoke","settling smoke");G=c("rocket_smoke","rocket_smoke");H=a("rocket_Point_1");Ua=a("bm_13");L=c("rockets_box","rockets_box_Armature");Va=ua.get_light_params(H);c=m.get_tsr;a=u.set;c(g,ya);c(ca,za);c(da,Aa);Aa[3]=1;u.subtract(Aa,za,Ba);c(Ta,Na);a(0,-1.1,0,Ga);a(0,85,0,Ma);c(H,Wa);c=l.get_object_by_name("control_box");f=h.multiply(h.invert(ya,h.create()),m.get_tsr(c),h.create());a=Math.abs(f[1]);f=h.get_quat_view(f);S.append_stiff_viewport(c,
g,{right:0,bottom:0,distance:a,rotation:f});S.append_track(H,Ua);Xa();b.apply(g,T);b.set_last_frame(g);window.addEventListener("resize",wa)}function Xa(){T=window.innerWidth>window.innerHeight?"Camera_wide screen_Action":"Camera_narrow_screen_Action";g&&1==ba&&!b.is_play(g)&&b.apply(g,T)}function sb(a){var c=J.copy,f=l.show_object,e=l.append_object,h=l.remove_object,d=b.apply,g=b.play,k=b.SLOT_1,r=m.set_tsr,q=c(ca,"firework_"+a,!0),p=c(da,"firework_"+a+t+1,!0),n=c(ta,"firework_"+a+t+2,!0);f(q);f(p);
f(n);var c=Math.floor(Math.random()*Ya.length),c=Ya[c],f=.4*-Math.random()+-.2,u=2*Math.random()+-1,x=.3*-Math.random()+0;J.set_nodemat_rgb(p,["firework_2","RGB"],c[0]/255,c[1]/255,c[2]/255);J.set_nodemat_rgb(n,["firework_2","RGB"],c[0]/255,c[1]/255,c[2]/255);c=Za(za,f,u,0,x,wb);f=Za(c,Ba[0],Ba[1],.03*a,0,xb);r(q,c);r(p,f);r(n,f);var v=null;t==a-1&&(v=yb);E.set_timeout(function(){e(q);e(p);e(n);d(q,"firework_1_Shader_NodetreeAction");d(p,"firework_2_Action");d(p,"firework_2_Shader_NodetreeAction",
k);d(n,"firework_2_Action");d(n,"firework_2_Shader_NodetreeAction",k);g(q,function(){h(q)});g(n);g(p,function(){h(p)});g(n,function(){h(n);v&&v()},k)},fa);fa+=500*(.5+Math.random())}function yb(){p.stop(ea);b.play(W,zb)}function zb(){xa.addEventListener("click",$a);var a=X.style;a.opacity=0;a.display="block";a=ha.style;a.opacity=0;a.display="block";a=ia.style;a.opacity=0;a.display="block";P.css_animate(X,"opacity",0,1,1E3,"","",function(){P.css_animate(ha,"opacity",0,1,300);P.css_animate(ia,"opacity",
0,1,500)});b.apply(n,"bm_13_Armature_rotate_-20_Action");b.set_behavior(n,b.AB_FINISH_STOP);b.set_first_frame(n)}function $a(){ha.style.display="";ia.style.display="";X.style.display="";J.set_nodemat_value(K,["control_box","Value"],0);b.set_first_frame(g);xa.removeEventListener("click",$a);t=0;m.set_tsr(g,ya);m.set_tsr(H,Wa);ua.set_light_params(H,Va);b.apply(g,T);b.set_first_frame(K);b.set_first_frame(A);p.play_def(U);ba=1;ab()}function Za(a,b,f,e,d,g){h.identity(g);d=R.setAxisAngle(I.AXIS_Z,d,sa);
b=u.set(b,f,e,aa);h.set_trans(b,g);h.set_quat(d,g);h.multiply(a,g,g);return g}function Da(){Ab.resize_to_container();Xa()}function jb(a){var b=r.querySelector("#preloader_line_left"),f=r.querySelector("#preloader_line_right"),e=r.querySelector("#percentage");100==a?Bb():(40>=a?b.style.width=2*a+"%":40<a&&60>a?b.style.width="100%":60<a&&(b.style.width="100%",f.style.width=2*(a-50)+"%"),e.innerHTML=a)}function fb(){r=document.querySelector("#preloader_container");var a=r.querySelector("#bg_image_container"),
b=r.querySelector("#bg_fade_container"),f=r.querySelector("#sun_container"),e=r.querySelector("#preloader"),d=P.css_animate;d(b,"opacity",0,.6,300);d(r,"opacity",0,1,300,"","",function(){d(a,"opacity",0,1,300,"","",function(){d(f,"opacity",0,1,300,"","",function(){d(e,"opacity",0,1,300,"","",function(){Ca.resume();main_canvas_container.style.visibility="visible"})})})})}function Bb(){Cb();P.css_animate(r,"opacity",1,0,300,"","",function(){r.parentNode.removeChild(r)})}function Cb(){var a=x.querySelector("#close_info_but"),
b=x.querySelector("#run_button"),d=x.querySelector("#info"),e=x.querySelector("#sound_cont");a.addEventListener("click",bb);b.addEventListener("click",bb);e.addEventListener("click",Db);x.style.display="block";d.style.display="block";b.style.display="block";document.querySelector("#content");ga=x.scrollHeight;wa()}function Db(){var a=x.querySelector("#sound_cont");"active"==a.className?(a.className="",p.mute(null,!0)):(a.className="active",p.mute(null,!1))}function bb(){var a=document.querySelector("#background_color");
window.removeEventListener("resize",wa);l.hide_object(na);l.hide_object(oa);x.parentNode.removeChild(x);a.parentNode.removeChild(a);a=l.get_object_by_dupli_name("red_square","clock_spk");p.stop(a);p.stop(U);p.play_def(a);p.play_def(U);b.set_speed(g,-1);b.set_behavior(g,b.AB_FINISH_STOP);b.play(g,ab)}function ab(){b.apply(L,"opening_rockets_box_Action");b.set_first_frame(L);b.set_behavior(L,b.AB_FINISH_STOP);b.play(L,Eb)}function Eb(){b.apply(n,"bm_13_Armature_rotate_-20_Action");b.set_first_frame(n);
b.set_behavior(n,b.AB_FINISH_STOP);b.play(n,Fb)}function Fb(){k.removeEventListener("mousedown",B);k.removeEventListener("touchstart",B);k.removeEventListener("mousemove",Y);k.removeEventListener("touchmove",Y);k.removeEventListener("mouseup",Q);k.removeEventListener("touchend",Q);document.removeEventListener("mouseout",Q);k.addEventListener("mousedown",B);k.addEventListener("touchstart",B);k.addEventListener("mousemove",Y);k.addEventListener("touchmove",Y);k.addEventListener("mouseup",Q);k.addEventListener("touchend",
Q);document.addEventListener("mouseout",Q);ba=1}var b=d("animation"),P=d("app"),Pa=d("camera"),gb=d("config"),S=d("constraints"),Ab=d("container");d("controls");var hb=d("data"),ua=d("lights"),Ca=d("main"),Qa=d("math"),Z=d("mouse"),J=d("objects"),l=d("scenes"),p=d("sfx"),E=d("time"),m=d("transform"),h=d("tsr"),I=d("util"),Gb=d("version"),R=d("quat"),u=d("vec3"),cb="DEBUG"===Gb.type(),C=[],Ya=[[255,255,0],[255,0,148],[0,255,0],[0,0,255],[161,0,255],[255,255,255],[94,255,255]],ya=new Float32Array(8),
Na=new Float32Array(8),za=new Float32Array(8),Aa=new Float32Array(8),Wa=new Float32Array(8),wb=new Float32Array(8),xb=new Float32Array(8),Ba=new Float32Array(3),Ga=new Float32Array(3),Ma=new Float32Array(3),aa=new Float32Array(3),Ra=new Float32Array(3),va=new Float32Array(3),Sa=new Float32Array(3),pa=new Float32Array([0,0,0]),rb=new Float32Array([0,0,1]);new Float32Array([0,-1.2,0]);var ub=new Float32Array(4),sa=new Float32Array(4),Oa=new Float32Array(4),vb=new Float32Array(4),tb=Qa.create_pline(),
W=null,Ua=null,n=null,ma=null,k=null,g=null,Ta=null,K=null,A=null,q=null,la=null,ca=null,da=null,ta=null,ea=null,H=null,Ha=null,Ia=null,U=null,Ja=null,N=null,O=null,Ka=null,La=null,G=null,na=null,L=null,oa=null,qa=null,ha=null,x=null,X=null,xa=null,ia=null,ga=0,r=null,ka=!1,ja=!1,ra=!1,T="",ba=0,fa=0,t=0,Va=null;db.init=function(){P.init({canvas_container_id:"main_canvas_container",callback:eb,alpha:!1,report_init_failure:!0,console_verbose:!0,assets_dds_available:!cb,assets_min50_available:!cb,show_fps:!1})}});
b4w.require("victory_day_2015_main").init();
